package com.bbb.internationalshipping.integration.checkoutrequest

import com.bbb.framework.jaxb.internationalshipping.checkoutrequest.EnvoyInitialParamsV2
import com.bbb.internationalshipping.vo.checkoutrequest.BBBInternationalCheckoutResponseVO
import com.bbb.exception.BBBBusinessException
import org.apache.commons.lang.StringEscapeUtils

import spock.lang.specification.BBBExtendedSpec

/**
 * @author Velmurugan Moorthy
 *
 * The class is to unit test the BBBInternationalCheckoutUnMarshaller class 
 * Unmarshaller takes the International Checkout response xml as input
 * populate  a BBBInternationalCheckoutResponseVO 
 *
 */

class BBBInternationalCheckoutUnMarshallerSpecification extends BBBExtendedSpec {

	BBBInternationalCheckoutUnMarshaller internationCheckoutUnMarshallerMock 
	
	def setup () {
	
		internationCheckoutUnMarshallerMock = Spy()
		
	}
	
	def "handleResponse - unmarshalling the response object is successful - happy flow " () {
		
		given : 
				String responseXml
				def BBBInternationalCheckoutResponseVO checkoutResponseVOMock = Mock()
				responseXml  = "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?><message>    <header/><payload>    <setCheckoutSessionResponse> <envoyInitialParams> <fiftyOneCheckoutSessionId>jmjlAOvfsXdAPjN7HQqRWeQ6kFSnQvZkac-tLy0XZDtJIBxv_GWB!1996088308!-1058809047</fiftyOneCheckoutSessionId> <fullEnvoyUrl>envoy.bedbath.com</fullEnvoyUrl></envoyInitialParams>      <domesticSession>            <domesticBasket currency=\"MXN\">                <basketItems>                    <basketItem sku=\"\">                        <quantity>10</quantity>                        <pricing>                            <listPrice>125.73</listPrice>                            <itemDiscount>10.0</itemDiscount>                            <salePrice>110.73</salePrice>                            <productExtraShipping>2.25</productExtraShipping>                            <productExtraHandling>3.45</productExtraHandling>                        </pricing>                        <display>                            <name>bbbDisplay01</name>                            <description>Dark red</description>                            <productUrl>/product/cambridge-300-thread-count-cotton-sheet-set/3278127</productUrl>                            <imageUrl>https://s7d9.scene7.com/is/image/BedBathandBeyond/7000123278127m</imageUrl>                            <color>red</color>                            <size>8</size>                        </display>                    </basketItem>                </basketItems>                <basketTotal>                    <totalSalePrice>110.73</totalSalePrice>                    <orderDiscount>6.75</orderDiscount>                    <totalProductExtraShipping>2.25</totalProductExtraShipping>                    <totalProductExtraHandling>3.45</totalProductExtraHandling>                    <totalPrice>110.73</totalPrice>                </basketTotal>            </domesticBasket>            <domesticShippingMethod>                <domesticShippingPrice>2.25</domesticShippingPrice>                <domesticHandlingPrice>3.35</domesticHandlingPrice>                <extraInsurancePrice>10.0</extraInsurancePrice>                <deliveryPromiseMinimum>2</deliveryPromiseMinimum>                <deliveryPromiseMaximum>3</deliveryPromiseMaximum>            </domesticShippingMethod>            <sessionDetails>                <buyerSessionId>buyerSession01</buyerSessionId>                <buyerIpAddress>160.132.133.12</buyerIpAddress>                <checkoutUrls>                    <successUrl>bedbath.com/checkout/success</successUrl>                    <pendingUrl>bedbath.com/checkout/pending</pendingUrl>                    <failureUrl>bedbath.com/cart</failureUrl>                    <basketUrl>bedbath.com/checkout/basket</basketUrl>                    <usCartStartPageUrl>bedbath.com/us/cart</usCartStartPageUrl>                    <paymentUrls>                        <payPalUrls>                            <returnUrl>bedbath.com/success</returnUrl>                            <cancelUrl>bedbath.com/checkout/failure</cancelUrl>                            <headerLogoUrl>paypal.com/logo.png</headerLogoUrl>                        </payPalUrls>                    </paymentUrls>                </checkoutUrls>            </sessionDetails>            <orderProperties>                <currencyQuoteId>1001</currencyQuoteId>                <lcpRuleId>1002</lcpRuleId>                <merchantOrderId>merch01</merchantOrderId>            </orderProperties>        </domesticSession>        <buyerSession>            <shipToAddress isPoBox=\"false\" isReadOnly=\"false\"/>            <buyerPreferences>                <language></language>                <buyerCurrency>MXN</buyerCurrency>            </buyerPreferences>        </buyerSession>    </setCheckoutSessionResponse></payload></message>"
	
		when : 					
			  	internationCheckoutUnMarshallerMock.handleResponse(responseXml, checkoutResponseVOMock)
	
		then : 
				1 * checkoutResponseVOMock.setFullEnvoyUrl(*_)
				1 * checkoutResponseVOMock.setInternationalOrderId(*_)
	}
	
	def "handleResponse - unmarshalling the response object is received with error" () {
		
		given :
				String responseXml
				def BBBInternationalCheckoutResponseVO checkoutResponseVOMock = Mock()
				responseXml  = "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?><message>    <header/><payload>   <errorResponse><errors><error><id>error01</id></error></errors></errorResponse> <setCheckoutSessionResponse> <envoyInitialParams> <fiftyOneCheckoutSessionId>jmjlAOvfsXdAPjN7HQqRWeQ6kFSnQvZkac-tLy0XZDtJIBxv_GWB!1996088308!-1058809047</fiftyOneCheckoutSessionId> <fullEnvoyUrl>envoy.bedbath.com</fullEnvoyUrl></envoyInitialParams>      <domesticSession>            <domesticBasket currency=\"MXN\">                <basketItems>                    <basketItem sku=\"\">                        <quantity>10</quantity>                        <pricing>                            <listPrice>125.73</listPrice>                            <itemDiscount>10.0</itemDiscount>                            <salePrice>110.73</salePrice>                            <productExtraShipping>2.25</productExtraShipping>                            <productExtraHandling>3.45</productExtraHandling>                        </pricing>                        <display>                            <name>bbbDisplay01</name>                            <description>Dark red</description>                            <productUrl>/product/cambridge-300-thread-count-cotton-sheet-set/3278127</productUrl>                            <imageUrl>https://s7d9.scene7.com/is/image/BedBathandBeyond/7000123278127m</imageUrl>                            <color>red</color>                            <size>8</size>                        </display>                    </basketItem>                </basketItems>                <basketTotal>                    <totalSalePrice>110.73</totalSalePrice>                    <orderDiscount>6.75</orderDiscount>                    <totalProductExtraShipping>2.25</totalProductExtraShipping>                    <totalProductExtraHandling>3.45</totalProductExtraHandling>                    <totalPrice>110.73</totalPrice>                </basketTotal>            </domesticBasket>            <domesticShippingMethod>                <domesticShippingPrice>2.25</domesticShippingPrice>                <domesticHandlingPrice>3.35</domesticHandlingPrice>                <extraInsurancePrice>10.0</extraInsurancePrice>                <deliveryPromiseMinimum>2</deliveryPromiseMinimum>                <deliveryPromiseMaximum>3</deliveryPromiseMaximum>            </domesticShippingMethod>            <sessionDetails>                <buyerSessionId>buyerSession01</buyerSessionId>                <buyerIpAddress>160.132.133.12</buyerIpAddress>                <checkoutUrls>                    <successUrl>bedbath.com/checkout/success</successUrl>                    <pendingUrl>bedbath.com/checkout/pending</pendingUrl>                    <failureUrl>bedbath.com/cart</failureUrl>                    <basketUrl>bedbath.com/checkout/basket</basketUrl>                    <usCartStartPageUrl>bedbath.com/us/cart</usCartStartPageUrl>                    <paymentUrls>                        <payPalUrls>                            <returnUrl>bedbath.com/success</returnUrl>                            <cancelUrl>bedbath.com/checkout/failure</cancelUrl>                            <headerLogoUrl>paypal.com/logo.png</headerLogoUrl>                        </payPalUrls>                    </paymentUrls>                </checkoutUrls>            </sessionDetails>            <orderProperties>                <currencyQuoteId>1001</currencyQuoteId>                <lcpRuleId>1002</lcpRuleId>                <merchantOrderId>merch01</merchantOrderId>            </orderProperties>        </domesticSession>        <buyerSession>            <shipToAddress isPoBox=\"false\" isReadOnly=\"false\"/>            <buyerPreferences>                <language></language>                <buyerCurrency>MXN</buyerCurrency>            </buyerPreferences>        </buyerSession>    </setCheckoutSessionResponse></payload></message>"
	
		when :
				  internationCheckoutUnMarshallerMock.handleResponse(responseXml, checkoutResponseVOMock)
	
		then :
				1 * checkoutResponseVOMock.setErrorMessage(*_)
				0 * checkoutResponseVOMock.setFullEnvoyUrl(*_)
				0 * checkoutResponseVOMock.setInternationalOrderId(*_)
	}

	def "handleResponse - unmarshalling the response object is failed - (JAXBException)" () {
		
		given :
				String responseXml
				EnvoyInitialParamsV2 envoyInitialParamsMock = Mock()
				def BBBInternationalCheckoutResponseVO checkoutResponseVOMock = null
				responseXml  = "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?><message>    <header/><payload>    <setCheckoutSessionResponse> <envoyInitialParams> <fiftyOneCheckoutSessionId>jmjlAOvfsXdAPjN7HQqRWeQ6kFSnQvZkac-tLy0XZDtJIBxv_GWB!1996088308!-1058809047</fiftyOneCheckoutSessionId> <fullEnvoyUrl>envoy.bedbath.com</fullEnvoyUrl></envoyInitialParams>      <domesticSession>            <domesticBasket currency=\"MXN\">                <basketItems>                    <basketItem sku=\"\">                        <quantity>10</quantity>                        <pricing>                            <listPrice>125.73</listPrice>                            <itemDiscount>10.0</itemDiscount>                            <salePrice>110.73</salePrice>                            <productExtraShipping>2.25</productExtraShipping>                            <productExtraHandling>3.45</productExtraHandling>                        </pricing>                        <display>                            <name>bbbDisplay01</name>                            <description>Dark red</description>                            <productUrl>/product/cambridge-300-thread-count-cotton-sheet-set/3278127</productUrl>                            <imageUrl>https://s7d9.scene7.com/is/image/BedBathandBeyond/7000123278127m</imageUrl>                            <color>red</color>                            <size>8</size>                        </display>                    </basketItem>                </basketItems>                <basketTotal>                    <totalSalePrice>110.73</totalSalePrice>                    <orderDiscount>6.75</orderDiscount>                    <totalProductExtraShipping>2.25</totalProductExtraShipping>                    <totalProductExtraHandling>3.45</totalProductExtraHandling>                    <totalPrice>110.73</totalPrice>                </basketTotal>            </domesticBasket>            <domesticShippingMethod>                <domesticShippingPrice>2.25</domesticShippingPrice>                <domesticHandlingPrice>3.35</domesticHandlingPrice>                <extraInsurancePrice>10.0</extraInsurancePrice>                <deliveryPromiseMinimum>2</deliveryPromiseMinimum>                <deliveryPromiseMaximum>3</deliveryPromiseMaximum>            </domesticShippingMethod>            <sessionDetails>                <buyerSessionId>buyerSession01</buyerSessionId>                <buyerIpAddress>160.132.133.12</buyerIpAddress>                <checkoutUrls>                    <successUrl>bedbath.com/checkout/success</successUrl>                    <pendingUrl>bedbath.com/checkout/pending</pendingUrl>                    <failureUrl>bedbath.com/cart</failureUrl>                    <basketUrl>bedbath.com/checkout/basket</basketUrl>                    <usCartStartPageUrl>bedbath.com/us/cart</usCartStartPageUrl>                    <paymentUrls>                        <payPalUrls>                            <returnUrl>bedbath.com/success</returnUrl>                            <cancelUrl>bedbath.com/checkout/failure</cancelUrl>                            <headerLogoUrl>paypal.com/logo.png</headerLogoUrl>                        </payPalUrls>                    </paymentUrls>                </checkoutUrls>            </sessionDetails>            <orderProperties>                <currencyQuoteId>1001</currencyQuoteId>                <lcpRuleId>1002</lcpRuleId>                <merchantOrderId>merch01</merchantOrderId>            </orderProperties>        </domesticSession>        <buyerSession>            <shipToAddress isPoBox=\"false\" isReadOnly=\"false\"/>            <buyerPreferences>                <language></language>                <buyerCurrency>MXN</buyerCurrency>            </buyerPreferences>        </buyerSession>    </setCheckoutSessionResponse></payload></message>"
	
		when :
				  internationCheckoutUnMarshallerMock.handleResponse("", checkoutResponseVOMock)
	
		then :
				0 * checkoutResponseVOMock.setFullEnvoyUrl(*_)
				0 * checkoutResponseVOMock.setInternationalOrderId(*_)
				thrown BBBBusinessException
	}
	
	def "handleResponse - checkoutSessionID is not set (empty)" () {
		
		given :
				String responseXml
				EnvoyInitialParamsV2 envoyInitialParamsMock = Mock()
				def BBBInternationalCheckoutResponseVO checkoutResponseVOMock = Mock()
				responseXml  = "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?><message>    <header/><payload>    <setCheckoutSessionResponse> <envoyInitialParams> <fiftyOneCheckoutSessionId></fiftyOneCheckoutSessionId> <fullEnvoyUrl>envoy.bedbath.com</fullEnvoyUrl></envoyInitialParams>      <domesticSession>            <domesticBasket currency=\"MXN\">                <basketItems>                    <basketItem sku=\"\">                        <quantity>10</quantity>                        <pricing>                            <listPrice>125.73</listPrice>                            <itemDiscount>10.0</itemDiscount>                            <salePrice>110.73</salePrice>                            <productExtraShipping>2.25</productExtraShipping>                            <productExtraHandling>3.45</productExtraHandling>                        </pricing>                        <display>                            <name>bbbDisplay01</name>                            <description>Dark red</description>                            <productUrl>/product/cambridge-300-thread-count-cotton-sheet-set/3278127</productUrl>                            <imageUrl>https://s7d9.scene7.com/is/image/BedBathandBeyond/7000123278127m</imageUrl>                            <color>red</color>                            <size>8</size>                        </display>                    </basketItem>                </basketItems>                <basketTotal>                    <totalSalePrice>110.73</totalSalePrice>                    <orderDiscount>6.75</orderDiscount>                    <totalProductExtraShipping>2.25</totalProductExtraShipping>                    <totalProductExtraHandling>3.45</totalProductExtraHandling>                    <totalPrice>110.73</totalPrice>                </basketTotal>            </domesticBasket>            <domesticShippingMethod>                <domesticShippingPrice>2.25</domesticShippingPrice>                <domesticHandlingPrice>3.35</domesticHandlingPrice>                <extraInsurancePrice>10.0</extraInsurancePrice>                <deliveryPromiseMinimum>2</deliveryPromiseMinimum>                <deliveryPromiseMaximum>3</deliveryPromiseMaximum>            </domesticShippingMethod>            <sessionDetails>                <buyerSessionId>buyerSession01</buyerSessionId>                <buyerIpAddress>160.132.133.12</buyerIpAddress>                <checkoutUrls>                    <successUrl>bedbath.com/checkout/success</successUrl>                    <pendingUrl>bedbath.com/checkout/pending</pendingUrl>                    <failureUrl>bedbath.com/cart</failureUrl>                    <basketUrl>bedbath.com/checkout/basket</basketUrl>                    <usCartStartPageUrl>bedbath.com/us/cart</usCartStartPageUrl>                    <paymentUrls>                        <payPalUrls>                            <returnUrl>bedbath.com/success</returnUrl>                            <cancelUrl>bedbath.com/checkout/failure</cancelUrl>                            <headerLogoUrl>paypal.com/logo.png</headerLogoUrl>                        </payPalUrls>                    </paymentUrls>                </checkoutUrls>            </sessionDetails>            <orderProperties>                <currencyQuoteId>1001</currencyQuoteId>                <lcpRuleId>1002</lcpRuleId>                <merchantOrderId>merch01</merchantOrderId>            </orderProperties>        </domesticSession>        <buyerSession>            <shipToAddress isPoBox=\"false\" isReadOnly=\"false\"/>            <buyerPreferences>                <language></language>                <buyerCurrency>MXN</buyerCurrency>            </buyerPreferences>        </buyerSession>    </setCheckoutSessionResponse></payload></message>"
	
		when :
				  internationCheckoutUnMarshallerMock.handleResponse(responseXml, checkoutResponseVOMock)
	
		then :
				0 * checkoutResponseVOMock.setInternationalOrderId(*_)
				1 * internationCheckoutUnMarshallerMock.logError("checkoutSessionID received is null")
	}
	
	def "handleResponse - checkoutSessionID is not set (order ID attribute in the seesion) not set" () {
		
		given :
				String responseXml
				EnvoyInitialParamsV2 envoyInitialParamsMock = Mock()
				def BBBInternationalCheckoutResponseVO checkoutResponseVOMock = Mock()
				responseXml  = "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?><message>    <header/><payload>    <setCheckoutSessionResponse> <envoyInitialParams> <fiftyOneCheckoutSessionId>jmjlAOvfsXdAPjN7HQqRWeQ6kFSnQvZkac</fiftyOneCheckoutSessionId> <fullEnvoyUrl>envoy.bedbath.com</fullEnvoyUrl></envoyInitialParams>      <domesticSession>            <domesticBasket currency=\"MXN\">                <basketItems>                    <basketItem sku=\"\">                        <quantity>10</quantity>                        <pricing>                            <listPrice>125.73</listPrice>                            <itemDiscount>10.0</itemDiscount>                            <salePrice>110.73</salePrice>                            <productExtraShipping>2.25</productExtraShipping>                            <productExtraHandling>3.45</productExtraHandling>                        </pricing>                        <display>                            <name>bbbDisplay01</name>                            <description>Dark red</description>                            <productUrl>/product/cambridge-300-thread-count-cotton-sheet-set/3278127</productUrl>                            <imageUrl>https://s7d9.scene7.com/is/image/BedBathandBeyond/7000123278127m</imageUrl>                            <color>red</color>                            <size>8</size>                        </display>                    </basketItem>                </basketItems>                <basketTotal>                    <totalSalePrice>110.73</totalSalePrice>                    <orderDiscount>6.75</orderDiscount>                    <totalProductExtraShipping>2.25</totalProductExtraShipping>                    <totalProductExtraHandling>3.45</totalProductExtraHandling>                    <totalPrice>110.73</totalPrice>                </basketTotal>            </domesticBasket>            <domesticShippingMethod>                <domesticShippingPrice>2.25</domesticShippingPrice>                <domesticHandlingPrice>3.35</domesticHandlingPrice>                <extraInsurancePrice>10.0</extraInsurancePrice>                <deliveryPromiseMinimum>2</deliveryPromiseMinimum>                <deliveryPromiseMaximum>3</deliveryPromiseMaximum>            </domesticShippingMethod>            <sessionDetails>                <buyerSessionId>buyerSession01</buyerSessionId>                <buyerIpAddress>160.132.133.12</buyerIpAddress>                <checkoutUrls>                    <successUrl>bedbath.com/checkout/success</successUrl>                    <pendingUrl>bedbath.com/checkout/pending</pendingUrl>                    <failureUrl>bedbath.com/cart</failureUrl>                    <basketUrl>bedbath.com/checkout/basket</basketUrl>                    <usCartStartPageUrl>bedbath.com/us/cart</usCartStartPageUrl>                    <paymentUrls>                        <payPalUrls>                            <returnUrl>bedbath.com/success</returnUrl>                            <cancelUrl>bedbath.com/checkout/failure</cancelUrl>                            <headerLogoUrl>paypal.com/logo.png</headerLogoUrl>                        </payPalUrls>                    </paymentUrls>                </checkoutUrls>            </sessionDetails>            <orderProperties>                <currencyQuoteId>1001</currencyQuoteId>                <lcpRuleId>1002</lcpRuleId>                <merchantOrderId>merch01</merchantOrderId>            </orderProperties>        </domesticSession>        <buyerSession>            <shipToAddress isPoBox=\"false\" isReadOnly=\"false\"/>            <buyerPreferences>                <language></language>                <buyerCurrency>MXN</buyerCurrency>            </buyerPreferences>        </buyerSession>    </setCheckoutSessionResponse></payload></message>"
	
		when :
				  internationCheckoutUnMarshallerMock.handleResponse(responseXml, checkoutResponseVOMock)
	
		then :
				0 * checkoutResponseVOMock.setInternationalOrderId(*_)
				1 * internationCheckoutUnMarshallerMock.logError("checkoutSessionID received is null")
	}
		
}
