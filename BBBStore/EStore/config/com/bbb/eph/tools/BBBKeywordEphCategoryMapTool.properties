$class=com.bbb.eph.tools.BBBKeywordEphCategoryMapTool
$scope=global
description=Tool component to build mapping of keyword with EPH by top(highest boost score) 'n' number of OBP 
ephCatRepository=/com/bbb/eph/repository/SearchKeyEphCatMappingRepository
omnitureReportRepository=/com/bbb/thirdparty/omniture/repository/OmnitureReportRepository
bbbCatalogTools=/com/bbb/commerce/catalog/BBBCatalogTools
productAndEphWithKeywordByConcept=WITH DATATABLE AS (SELECT * FROM (SELECT REPORTDATA.* ,ROW_NUMBER() OVER (PARTITION BY REPORTDATA.KEYWORD ORDER BY REPORTDATA.BOOST_SCORE DESC) AS RNK FROM BBB_OMNITURE_REPORT_DATA REPORTDATA WHERE REPORTDATA.LAST_MODIFIED_DATE > ? AND REPORTDATA.CONCEPT =? AND REPORTDATA.REPORT_TYPE='OBP') WHERE RNK <=? ) SELECT DT.KEYWORD,DT.PRODUCT_ID, EPH.EPH_PROD_NODE_ID FROM DATATABLE DT LEFT OUTER JOIN BBB_MISC.BBB_PRODUCT_EPH EPH ON DT.PRODUCT_ID=EPH.PRODUCT_ID ORDER BY KEYWORD
idGenerator=/atg/dynamo/service/IdGenerator
keywordtoEphCatMappSeedName=keywordtoEphCatMappingId
insertKeywordToEphCatMapQuery=INSERT INTO BBB_KEYWORD_EPH_CAT  (ID,SEARCH_KEYWORD ,CONCEPT,EPH_IDS,CATEGORY_IDS,LAST_MODIFIED_DATE) VALUES(?,?,?,?,?,?)
updateKeywordToEphCatMapQuery=UPDATE BBB_KEYWORD_EPH_CAT SET EPH_IDS=? ,CATEGORY_IDS=? ,LAST_MODIFIED_DATE=? WHERE ID=?
latestModifiedDateForConcept=SELECT NVL(MAX(LAST_MODIFIED_DATE),SYSDATE-1) AS LAST_MODIFIED_DATE FROM BBB_KEYWORD_EPH_CAT WHERE CONCEPT=?
loggingDebug=false
allProductAndEphWithKeywordByConcept=WITH DATATABLE AS (SELECT * FROM (SELECT REPORTDATA.* ,ROW_NUMBER() OVER (PARTITION BY REPORTDATA.KEYWORD ORDER BY REPORTDATA.BOOST_SCORE DESC) AS RNK FROM BBB_OMNITURE_REPORT_DATA REPORTDATA WHERE REPORTDATA.CONCEPT =? AND REPORTDATA.REPORT_TYPE='OBP') WHERE RNK <=? ) SELECT DT.KEYWORD,DT.PRODUCT_ID, EPH.EPH_PROD_NODE_ID FROM DATATABLE DT LEFT OUTER JOIN BBB_MISC.BBB_PRODUCT_EPH EPH ON DT.PRODUCT_ID=EPH.PRODUCT_ID ORDER BY KEYWORD
removeOldMappingsQuery=delete from BBB_KEYWORD_EPH_CAT where last_modified_date < (SYSDATE-?)